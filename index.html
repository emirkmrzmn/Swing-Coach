<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0f0a">
<title>SwingCoach</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f0a;
    --surface: #111811;
    --surface2: #182018;
    --border: #2a362a;
    --green: #4ade80;
    --green-dim: #22c55e44;
    --green-muted: #86efac;
    --red: #f87171;
    --text: #e8f0e8;
    --text-muted: #7a9a7a;
    --text-dim: #4a6a4a;
    --font-display: 'DM Serif Display', serif;
    --font-body: 'Instrument Sans', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100dvh; overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom); }
  .screen { display: none; min-height: 100dvh; flex-direction: column; }
  .screen.active { display: flex; }
  .hidden { display: none !important; }

  /* SETUP */
  #screen-setup { background: var(--bg); position: relative; overflow: hidden; }
  .setup-hero { padding: 60px 28px 36px; position: relative; z-index: 1; }
  .setup-hero::before { content: ''; position: absolute; top: -80px; left: -80px; width: 340px; height: 340px; background: radial-gradient(circle, #4ade8022 0%, transparent 70%); pointer-events: none; }
  .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
  .logo-icon { width: 36px; height: 36px; background: var(--green); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .logo-text { font-family: var(--font-display); font-size: 22px; }
  .hero-label { font-family: var(--font-mono); font-size: 11px; letter-spacing: 2px; color: var(--green); text-transform: uppercase; margin-bottom: 14px; }
  .hero-title { font-family: var(--font-display); font-size: 42px; line-height: 1.05; letter-spacing: -1px; margin-bottom: 16px; }
  .hero-title em { font-style: italic; color: var(--green); }
  .hero-sub { font-size: 15px; color: var(--text-muted); line-height: 1.6; }
  .setup-body { flex: 1; padding: 0 28px 40px; display: flex; flex-direction: column; gap: 14px; z-index: 1; position: relative; }
  .setup-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-top: 8px; }
  .input-field { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; font-family: var(--font-mono); font-size: 13px; color: var(--text); width: 100%; outline: none; transition: border-color 0.2s; }
  .input-field:focus { border-color: var(--green); }
  .input-field::placeholder { color: var(--text-dim); }
  .input-hint { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

  /* BUTTONS */
  .btn-primary { background: var(--green); color: #0a0f0a; border: none; border-radius: var(--radius-sm); padding: 18px 24px; font-family: var(--font-body); font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: opacity 0.2s, transform 0.1s; letter-spacing: -0.2px; }
  .btn-primary:active { opacity: 0.85; transform: scale(0.98); }
  .btn-secondary { background: var(--surface); color: var(--text); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 16px 24px; font-family: var(--font-body); font-size: 15px; font-weight: 500; cursor: pointer; width: 100%; }
  .btn-secondary:active { opacity: 0.8; }

  /* PAGE HEADER */
  .page-header { padding: 56px 24px 24px; border-bottom: 1px solid var(--border); }
  .back-btn { background: none; border: none; color: var(--text-muted); font-family: var(--font-body); font-size: 14px; cursor: pointer; padding: 0; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }
  .page-title { font-family: var(--font-display); font-size: 30px; letter-spacing: -0.5px; }
  .page-sub { font-size: 14px; color: var(--text-muted); margin-top: 6px; line-height: 1.5; }
  .focus-pill { display: inline-flex; align-items: center; gap: 6px; background: var(--green-dim); border: 1px solid var(--green); border-radius: 100px; padding: 5px 12px; font-family: var(--font-mono); font-size: 11px; color: var(--green); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }

  /* FOCUS SCREEN */
  #screen-focus { overflow-y: auto; padding-bottom: 100px; }
  .focus-grid { padding: 20px 24px; display: flex; flex-direction: column; gap: 12px; }
  .focus-card { background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--radius); padding: 18px; cursor: pointer; transition: border-color 0.2s, background 0.2s; display: flex; align-items: flex-start; gap: 14px; }
  .focus-card.selected { border-color: var(--green); background: var(--green-dim); }
  .focus-card:active { opacity: 0.8; }
  .focus-icon { font-size: 22px; width: 42px; height: 42px; background: var(--surface2); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .focus-card.selected .focus-icon { background: #4ade8022; }
  .focus-info { flex: 1; }
  .focus-name { font-weight: 600; font-size: 15px; margin-bottom: 3px; }
  .focus-desc { font-size: 13px; color: var(--text-muted); line-height: 1.45; }
  .focus-check { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin-top: 2px; }
  .focus-card.selected .focus-check { background: var(--green); border-color: var(--green); color: #0a0f0a; font-size: 12px; }
  .focus-actions { padding: 16px 24px 32px; }

  /* RECORD SCREEN */
  #screen-record { overflow-y: auto; padding-bottom: 100px; }
  .record-header { padding: 56px 24px 20px; border-bottom: 1px solid var(--border); }
  .view-tip { margin: 14px 24px 0; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 14px; display: flex; gap: 10px; align-items: flex-start; }
  .tip-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 1.5px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 3px; }
  .tip-text { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

  .video-zone { padding: 16px 24px 0; }
  .zone-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .zone-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); }
  .zone-status { font-size: 12px; color: var(--text-dim); }
  .zone-status.ready { color: var(--green); }

  .video-slot { background: var(--surface); border: 1.5px dashed var(--border); border-radius: var(--radius); aspect-ratio: 16/9; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; position: relative; overflow: hidden; margin-bottom: 10px; }
  .video-slot.has-video { border-style: solid; border-color: var(--green); }
  .video-slot video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
  .video-slot-icon { font-size: 28px; opacity: 0.3; }
  .video-slot-text { font-size: 12px; color: var(--text-dim); text-align: center; line-height: 1.5; }
  .video-slot-badge { position: absolute; top: 10px; right: 10px; background: var(--green); color: #0a0f0a; font-family: var(--font-mono); font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 500; }
  .video-slot-clear { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.65); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  .video-actions { display: flex; gap: 10px; margin-bottom: 6px; }
  .btn-cam { flex: 1; background: var(--red); color: white; border: none; border-radius: var(--radius-sm); padding: 14px 8px; font-family: var(--font-body); font-size: 14px; font-weight: 600; cursor: pointer; }
  .btn-lib { flex: 1; background: var(--surface); color: var(--text); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 14px 8px; font-family: var(--font-body); font-size: 14px; cursor: pointer; }
  .btn-cam:active, .btn-lib:active { opacity: 0.8; }

  .ios-note { font-size: 11px; color: var(--text-dim); text-align: center; margin-bottom: 4px; font-family: var(--font-mono); }

  .record-footer { padding: 20px 24px 0; display: flex; flex-direction: column; gap: 10px; }
  .session-bar { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
  .session-label { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }
  .session-val { font-family: var(--font-mono); font-size: 13px; color: var(--green); font-weight: 500; }

  /* ANALYSIS */
  #screen-analysis { overflow-y: auto; padding-bottom: 100px; }
  .analysis-header { padding: 56px 24px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg); z-index: 10; }
  .spinner { width: 50px; height: 50px; border: 3px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-state { padding: 60px 24px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; }
  .loading-title { font-family: var(--font-display); font-size: 24px; }
  .loading-sub { font-size: 14px; color: var(--text-muted); }
  .loading-steps { display: flex; flex-direction: column; gap: 10px; text-align: left; width: 100%; }
  .step { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-dim); font-family: var(--font-mono); }
  .step.active { color: var(--green); }
  .step.done { color: var(--text-muted); }
  .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
  .step.active .step-dot { background: var(--green); animation: pulse 0.8s infinite; }
  .step.done .step-dot { background: var(--text-dim); }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.2; } }

  .results-container { padding: 24px; display: flex; flex-direction: column; gap: 20px; }
  .priority-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 100px; font-family: var(--font-mono); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; }
  .p1 { background: #f8717122; border: 1px solid #f87171; color: #f87171; }
  .p2 { background: #fbbf2422; border: 1px solid #fbbf24; color: #fbbf24; }
  .p3 { background: #4ade8022; border: 1px solid #4ade80; color: #4ade80; }

  .result-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .result-card-header { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
  .result-phase { font-family: var(--font-display); font-size: 18px; flex: 1; }
  .result-card-body { padding: 18px; display: flex; flex-direction: column; gap: 16px; }
  .rl { font-family: var(--font-mono); font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 5px; }
  .rt { font-size: 14px; line-height: 1.7; color: var(--text); }
  .rt-dim { font-size: 14px; line-height: 1.7; color: var(--text-muted); }

  .frame-img { width: 100%; border-radius: var(--radius-sm); object-fit: cover; max-height: 220px; border: 1.5px solid var(--green); display: block; }
  .frame-cap { font-family: var(--font-mono); font-size: 10px; color: var(--text-dim); margin-top: 5px; }

  .frame-strip { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .frame-strip::-webkit-scrollbar { display: none; }
  .frame-thumb-wrap { flex-shrink: 0; text-align: center; }
  .frame-thumb { width: 90px; height: 54px; border-radius: 7px; object-fit: cover; border: 1.5px solid var(--border); display: block; }
  .frame-thumb-cap { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); margin-top: 3px; width: 90px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .drill-box { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
  .drill-title { font-weight: 600; font-size: 14px; margin-bottom: 6px; }
  .drill-text { font-size: 13px; color: var(--text-muted); line-height: 1.65; }

  .top-banner { background: var(--green-dim); border: 1px solid var(--green); border-radius: var(--radius-sm); padding: 14px 16px; display: flex; gap: 12px; }
  .banner-icon { font-size: 18px; flex-shrink: 0; }
  .banner-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 1.5px; color: var(--green); text-transform: uppercase; margin-bottom: 4px; }
  .banner-text { font-size: 13px; color: var(--green-muted); line-height: 1.65; }

  .analysis-actions { padding: 0 24px 40px; display: flex; flex-direction: column; gap: 12px; }

  /* HISTORY */
  #screen-history { overflow-y: auto; padding-bottom: 100px; }
  .history-list { padding: 20px 24px; display: flex; flex-direction: column; gap: 12px; }
  .history-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 18px; cursor: pointer; }
  .history-item:active { opacity: 0.8; }
  .hi-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .hi-date { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }
  .hi-focus { font-size: 12px; color: var(--green); font-weight: 500; }
  .hi-summary { font-size: 13px; color: var(--text-muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .empty-state { padding: 60px 24px; text-align: center; color: var(--text-muted); font-size: 14px; line-height: 1.7; }
  .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }

  /* BOTTOM NAV */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,15,10,0.96); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; padding: 10px 0 calc(10px + env(safe-area-inset-bottom)); z-index: 50; }
  .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 6px; border: none; background: none; color: var(--text-dim); }
  .nav-item.active { color: var(--green); }
  .nav-icon { font-size: 22px; }
  .nav-label { font-size: 10px; font-family: var(--font-mono); }

  /* TOAST */
  .toast { position: fixed; bottom: 90px; left: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 16px; font-size: 14px; z-index: 200; transform: translateY(20px); opacity: 0; transition: all 0.3s; text-align: center; pointer-events: none; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--red); color: var(--red); }
  .toast.success { border-color: var(--green); color: var(--green); }
</style>
</head>
<body>

<!-- SETUP -->
<div id="screen-setup" class="screen active">
  <div class="setup-hero">
    <div class="logo"><div class="logo-icon">üèåÔ∏è</div><span class="logo-text">SwingCoach</span></div>
    <div class="hero-label">AI Golf Analysis</div>
    <h1 class="hero-title">Fix your swing,<br><em>one thing</em><br>at a time.</h1>
    <p class="hero-sub">Upload your swing videos and get AI coaching focused on your biggest priority. No information overload.</p>
  </div>
  <div class="setup-body">
    <div class="setup-label">Your Anthropic API Key</div>
    <input type="password" class="input-field" id="api-key-input" placeholder="sk-ant-api03-..." autocomplete="off" spellcheck="false">
    <p class="input-hint">Stored only on your device. Never shared. Get yours at console.anthropic.com</p>
    <button class="btn-primary" onclick="handleSetup()">Get Started ‚Üí</button>
  </div>
</div>

<!-- RECORD -->
<div id="screen-record" class="screen">
  <div class="record-header">
    <div class="focus-pill">üéØ <span id="focus-pill-text">‚Äî</span></div>
    <h2 class="page-title">New Session</h2>
    <p class="page-sub" id="record-sub">Add your swing video to get started</p>
  </div>

  <div class="view-tip">
    <span style="font-size:16px;flex-shrink:0;">üí°</span>
    <div><div class="tip-label">Recommended for your focus</div><div class="tip-text" id="view-tip-text">‚Äî</div></div>
  </div>

  <!-- Down the line -->
  <div class="video-zone">
    <div class="zone-row">
      <div class="zone-label" id="dtl-label">Down the Line</div>
      <div class="zone-status" id="dtl-status">No video</div>
    </div>
    <div class="video-slot" id="dtl-slot">
      <div class="video-slot-icon">üìπ</div>
      <div class="video-slot-text">Camera behind you,<br>pointing down the target line</div>
    </div>
    <div class="video-actions">
      <button class="btn-cam" onclick="triggerCapture('dtl')">üì∑ Open Camera</button>
      <button class="btn-lib" onclick="triggerLibrary('dtl')">üìÅ From Library</button>
    </div>
    <div class="ios-note">Tap "Open Camera" to record with your iPhone camera, then import</div>
  </div>

  <!-- Face on -->
  <div class="video-zone">
    <div class="zone-row">
      <div class="zone-label" id="fo-label">Face On</div>
      <div class="zone-status" id="fo-status">No video</div>
    </div>
    <div class="video-slot" id="fo-slot">
      <div class="video-slot-icon">üìπ</div>
      <div class="video-slot-text">Camera in front of you,<br>level with your hands</div>
    </div>
    <div class="video-actions">
      <button class="btn-cam" onclick="triggerCapture('fo')">üì∑ Open Camera</button>
      <button class="btn-lib" onclick="triggerLibrary('fo')">üìÅ From Library</button>
    </div>
  </div>

  <div class="record-footer">
    <div class="session-bar">
      <span class="session-label">Total analyses</span>
      <span class="session-val" id="session-val">0</span>
    </div>
    <button class="btn-primary" onclick="startAnalysis()">Analyse My Swing ‚Üí</button>
    <button class="btn-secondary" onclick="showFocusScreen()">Change Focus Area</button>
  </div>
</div>

<!-- FOCUS -->
<div id="screen-focus" class="screen">
  <div class="page-header">
    <button class="back-btn" onclick="showScreen('record')">‚Üê Back</button>
    <h2 class="page-title">Focus Area</h2>
    <p class="page-sub">Pick one area. All analysis will stay focused here until you move on.</p>
  </div>
  <div class="focus-grid">
    <div class="focus-card" data-focus="setup" onclick="selectFocus(this)">
      <div class="focus-icon">üßç</div>
      <div class="focus-info"><div class="focus-name">Setup & Address</div><div class="focus-desc">Grip, stance, ball position, posture and alignment</div></div>
      <div class="focus-check"></div>
    </div>
    <div class="focus-card" data-focus="backswing" onclick="selectFocus(this)">
      <div class="focus-icon">üîÑ</div>
      <div class="focus-info"><div class="focus-name">Backswing</div><div class="focus-desc">Takeaway, swing plane, shoulder turn, wrist position at the top</div></div>
      <div class="focus-check"></div>
    </div>
    <div class="focus-card" data-focus="downswing" onclick="selectFocus(this)">
      <div class="focus-icon">‚ö°</div>
      <div class="focus-info"><div class="focus-name">Downswing & Transition</div><div class="focus-desc">Weight shift, hip rotation, lag and sequence from top to impact</div></div>
      <div class="focus-check"></div>
    </div>
    <div class="focus-card" data-focus="impact" onclick="selectFocus(this)">
      <div class="focus-icon">üí•</div>
      <div class="focus-info"><div class="focus-name">Impact Position</div><div class="focus-desc">Club face, shaft lean, hand position and body at contact</div></div>
      <div class="focus-check"></div>
    </div>
    <div class="focus-card" data-focus="followthrough" onclick="selectFocus(this)">
      <div class="focus-icon">üåÄ</div>
      <div class="focus-info"><div class="focus-name">Follow-Through</div><div class="focus-desc">Extension through the ball, rotation and finish position</div></div>
      <div class="focus-check"></div>
    </div>
    <div class="focus-card" data-focus="overall" onclick="selectFocus(this)">
      <div class="focus-icon">üîç</div>
      <div class="focus-info"><div class="focus-name">Full Swing Overview</div><div class="focus-desc">AI picks the single biggest issue across your entire swing</div></div>
      <div class="focus-check"></div>
    </div>
  </div>
  <div class="focus-actions">
    <button class="btn-primary" onclick="confirmFocus()">Confirm Focus Area ‚Üí</button>
  </div>
</div>

<!-- ANALYSIS -->
<div id="screen-analysis" class="screen">
  <div class="analysis-header">
    <button class="back-btn" onclick="goToRecord()">‚Üê New Session</button>
    <h2 class="page-title">Analysis</h2>
    <div class="focus-pill" style="margin-top:8px;">üéØ <span id="analysis-focus-text">‚Äî</span></div>
  </div>

  <div id="analysis-loading" class="loading-state">
    <div class="spinner"></div>
    <div class="loading-title">Analysing your swing</div>
    <div class="loading-sub">Extracting frames and reviewing your mechanics...</div>
    <div class="loading-steps">
      <div class="step active" id="step-1"><div class="step-dot"></div>Extracting key frames</div>
      <div class="step" id="step-2"><div class="step-dot"></div>Sending to AI coach</div>
      <div class="step" id="step-3"><div class="step-dot"></div>Reviewing your focus area</div>
      <div class="step" id="step-4"><div class="step-dot"></div>Generating drill recommendations</div>
    </div>
  </div>

  <div id="analysis-results" class="hidden">
    <div class="results-container" id="results-content"></div>
    <div class="analysis-actions">
      <button class="btn-primary" onclick="goToRecord()">Record Another Swing ‚Üí</button>
      <button class="btn-secondary" onclick="showFocusScreen()">Change Focus Area</button>
      <button class="btn-secondary" onclick="showHistory()">View History</button>
    </div>
  </div>
</div>

<!-- HISTORY -->
<div id="screen-history" class="screen">
  <div class="page-header" style="position:sticky;top:0;background:var(--bg);z-index:10;">
    <h2 class="page-title">Your History</h2>
    <p class="page-sub">Past sessions and feedback</p>
  </div>
  <div class="history-list" id="history-list"></div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav" id="bottom-nav" style="display:none;">
  <button class="nav-item active" id="nav-record" onclick="showScreen('record');setNav('nav-record')">
    <span class="nav-icon">üìπ</span><span class="nav-label">Record</span>
  </button>
  <button class="nav-item" id="nav-history" onclick="showHistory();setNav('nav-history')">
    <span class="nav-icon">üìã</span><span class="nav-label">History</span>
  </button>
  <button class="nav-item" id="nav-settings" onclick="showSettings()">
    <span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span>
  </button>
</nav>

<!-- File inputs: capture= opens native camera; without it opens library -->
<input type="file" id="in-dtl-cap" accept="video/*" capture="environment" style="display:none" onchange="handleFile(event,'dtl')">
<input type="file" id="in-fo-cap"  accept="video/*" capture="environment" style="display:none" onchange="handleFile(event,'fo')">
<input type="file" id="in-dtl-lib" accept="video/*" style="display:none" onchange="handleFile(event,'dtl')">
<input type="file" id="in-fo-lib"  accept="video/*" style="display:none" onchange="handleFile(event,'fo')">

<div class="toast" id="toast"></div>

<script>
const state = {
  apiKey: '',
  focusArea: 'overall',
  dtlVideo: null,
  foVideo: null,
  sessionCount: 0,
  history: [],
  lastFrames: []
};

const FOCUS_LABELS = {
  setup: 'Setup & Address', backswing: 'Backswing',
  downswing: 'Downswing & Transition', impact: 'Impact Position',
  followthrough: 'Follow-Through', overall: 'Full Swing Overview'
};

const VIEW_TIPS = {
  setup:         { text: 'Face on is best ‚Äî shows alignment, ball position and posture clearly.', rec: 'fo' },
  backswing:     { text: 'Down the line is ideal ‚Äî reveals swing plane and club path most clearly.', rec: 'dtl' },
  downswing:     { text: 'Both views are useful. Down the line shows lag; face on shows hip drive and weight shift.', rec: 'both' },
  impact:        { text: 'Down the line is best ‚Äî shows shaft lean, club face and hand position clearly.', rec: 'dtl' },
  followthrough: { text: 'Face on works well ‚Äî shows your rotation and finish position clearly.', rec: 'fo' },
  overall:       { text: 'Down the line is the most informative single angle. Face on adds extra context.', rec: 'dtl' }
};

// INIT
window.addEventListener('DOMContentLoaded', () => {
  const key = localStorage.getItem('sc_key');
  state.focusArea    = localStorage.getItem('sc_focus') || 'overall';
  state.history      = JSON.parse(localStorage.getItem('sc_history') || '[]');
  state.sessionCount = parseInt(localStorage.getItem('sc_count') || '0');
  if (key) { state.apiKey = key; enterApp(); }
});

function handleSetup() {
  const k = document.getElementById('api-key-input').value.trim();
  if (!k.startsWith('sk-ant-')) { toast('Please enter a valid Anthropic API key (starts with sk-ant-)', 'error'); return; }
  state.apiKey = k;
  localStorage.setItem('sc_key', k);
  enterApp();
}

function enterApp() {
  document.getElementById('screen-setup').classList.remove('active');
  document.getElementById('bottom-nav').style.display = 'flex';
  if (!localStorage.getItem('sc_focus')) showFocusScreen();
  else showScreen('record');
  updateUI();
}

// NAV
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
}
function setNav(id) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
}
function goToRecord() { clearVideos(); showScreen('record'); setNav('nav-record'); }
function showFocusScreen() {
  showScreen('focus');
  document.querySelectorAll('.focus-card').forEach(c => {
    const sel = c.dataset.focus === state.focusArea;
    c.classList.toggle('selected', sel);
    c.querySelector('.focus-check').textContent = sel ? '‚úì' : '';
  });
}
function showHistory() { showScreen('history'); setNav('nav-history'); renderHistory(); }
function showSettings() {
  const k = prompt('Update API Key (blank to keep current):');
  if (k && k.startsWith('sk-ant-')) { state.apiKey = k; localStorage.setItem('sc_key', k); toast('API key updated', 'success'); }
  else if (k) toast('Invalid key format', 'error');
}

// UI
function updateUI() {
  const label = FOCUS_LABELS[state.focusArea];
  document.getElementById('focus-pill-text').textContent = label;
  document.getElementById('analysis-focus-text').textContent = label;
  document.getElementById('record-sub').textContent =
    state.focusArea === 'overall' ? 'AI identifies your biggest priority' : `Focused on: ${label}`;
  document.getElementById('session-val').textContent = state.sessionCount;

  const tip = VIEW_TIPS[state.focusArea] || VIEW_TIPS.overall;
  document.getElementById('view-tip-text').textContent = tip.text;

  const dtlRec = tip.rec === 'dtl' || tip.rec === 'both';
  const foRec  = tip.rec === 'fo'  || tip.rec === 'both';
  document.getElementById('dtl-label').innerHTML = `Down the Line${dtlRec ? ' <span style="color:var(--green)">‚òÖ</span>' : ''}`;
  document.getElementById('fo-label').innerHTML  = `Face On${foRec ? ' <span style="color:var(--green)">‚òÖ</span>' : ''}`;
}

// FOCUS
let tempFocus = null;
function selectFocus(card) {
  document.querySelectorAll('.focus-card').forEach(c => { c.classList.remove('selected'); c.querySelector('.focus-check').textContent = ''; });
  card.classList.add('selected'); card.querySelector('.focus-check').textContent = '‚úì';
  tempFocus = card.dataset.focus;
}
function confirmFocus() {
  if (!tempFocus) { toast('Please select a focus area', 'error'); return; }
  state.focusArea = tempFocus;
  localStorage.setItem('sc_focus', tempFocus);
  updateUI(); showScreen('record'); setNav('nav-record');
}

// VIDEO
function triggerCapture(a) { document.getElementById('in-' + a + '-cap').click(); }
function triggerLibrary(a) { document.getElementById('in-' + a + '-lib').click(); }

function handleFile(e, angle) {
  const file = e.target.files[0]; if (!file) return;
  state[angle + 'Video'] = file;
  const url = URL.createObjectURL(file);
  const slot = document.getElementById(angle + '-slot');
  slot.classList.add('has-video');
  slot.innerHTML = `
    <video src="${url}" muted playsinline webkit-playsinline></video>
    <div class="video-slot-badge">${angle === 'dtl' ? 'DTL' : 'FO'} ‚úì</div>
    <button class="video-slot-clear" onclick="clearVideo('${angle}',event)">‚úï</button>`;
  const st = document.getElementById(angle + '-status');
  st.textContent = '‚úì Ready'; st.className = 'zone-status ready';
  e.target.value = '';
}

function clearVideo(angle, e) {
  e?.stopPropagation();
  state[angle + 'Video'] = null;
  const slot = document.getElementById(angle + '-slot');
  slot.classList.remove('has-video');
  slot.innerHTML = `
    <div class="video-slot-icon">üìπ</div>
    <div class="video-slot-text">${angle === 'dtl' ? 'Camera behind you,<br>pointing down the target line' : 'Camera in front of you,<br>level with your hands'}</div>`;
  const st = document.getElementById(angle + '-status');
  st.textContent = 'No video'; st.className = 'zone-status';
}
function clearVideos() { clearVideo('dtl'); clearVideo('fo'); }

// ANALYSIS
async function startAnalysis() {
  if (!state.dtlVideo && !state.foVideo) { toast('Please add at least one video first', 'error'); return; }
  showScreen('analysis');
  document.getElementById('analysis-loading').classList.remove('hidden');
  document.getElementById('analysis-results').classList.add('hidden');

  try {
    setStep(1);
    const frames = await extractAll();
    state.lastFrames = frames;

    setStep(2); await delay(500);
    setStep(3);
    const analysis = await callClaude(frames);

    setStep(4); await delay(400);

    const record = {
      id: Date.now(),
      date: new Date().toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }),
      focus: state.focusArea,
      focusLabel: FOCUS_LABELS[state.focusArea],
      analysis,
      frames: frames.map(f => ({ label: f.label, phase: f.phase, base64: f.base64 }))
    };
    state.history.unshift(record);
    localStorage.setItem('sc_history', JSON.stringify(state.history.slice(0, 30)));
    state.sessionCount++;
    localStorage.setItem('sc_count', state.sessionCount);
    updateUI();
    renderResults(analysis, frames);
  } catch (err) {
    console.error(err);
    document.getElementById('analysis-loading').classList.add('hidden');
    toast('Analysis failed: ' + (err.message || 'Check your API key and credits'), 'error');
    showScreen('record');
  }
}

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step-' + i);
    el.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
  }
}

async function extractAll() {
  const frames = [];
  for (const src of [{ file: state.dtlVideo, label: 'down the line' }, { file: state.foVideo, label: 'face on' }]) {
    if (src.file) frames.push(...await extractFrames(src.file, src.label));
  }
  return frames;
}

function extractFrames(file, label) {
  return new Promise((resolve, reject) => {
    const video = document.createElement('video');
    const url = URL.createObjectURL(file);
    video.src = url; video.muted = true; video.playsInline = true;
    video.addEventListener('loadedmetadata', async () => {
      const dur = video.duration;
      const positions = [0.05, 0.30, 0.55, 0.82];
      const phases = ['Address', 'Backswing', 'Downswing / Impact', 'Follow-Through'];
      const frames = [];
      for (let i = 0; i < positions.length; i++) {
        const b64 = await captureFrame(video, dur * positions[i]);
        frames.push({ base64: b64, label, phase: phases[i] });
      }
      URL.revokeObjectURL(url);
      resolve(frames);
    });
    video.addEventListener('error', () => reject(new Error('Could not read video')));
    video.load();
  });
}

function captureFrame(video, time) {
  return new Promise(resolve => {
    video.currentTime = time;
    video.addEventListener('seeked', function h() {
      video.removeEventListener('seeked', h);
      const c = document.createElement('canvas');
      c.width = 640; c.height = 360;
      c.getContext('2d').drawImage(video, 0, 0, 640, 360);
      resolve(c.toDataURL('image/jpeg', 0.75).split(',')[1]);
    }, { once: true });
  });
}

async function callClaude(frames) {
  const focusLabel = FOCUS_LABELS[state.focusArea];
  const hasMulti = frames.some(f => f.label === 'down the line') && frames.some(f => f.label === 'face on');

  const system = `You are an expert PGA golf coach. Analyse swing frames and give structured, prioritised feedback.

Philosophy: Fix one thing at a time. Lead with the SINGLE most important change. Be specific and practical.

Student's chosen focus: ${focusLabel}
${state.focusArea !== 'overall' ? 'Stay focused on this phase only. Mention others only if they directly cause issues here.' : 'Identify the single biggest priority across the full swing.'}

IMPORTANT: Include "frameIndex" (0=Address, 1=Backswing, 2=Downswing/Impact, 3=Follow-Through) and "frameLabel" ("down the line" or "face on") in topPriority and each observation, indicating which frame best illustrates the point.

Return ONLY valid JSON:
{
  "topPriority": {
    "phase": "string",
    "issue": "one sentence",
    "why": "1-2 sentences",
    "fix": "2-3 sentences of specific practical instruction",
    "frameIndex": 2,
    "frameLabel": "down the line",
    "drill": { "name": "string", "instructions": "3-5 sentences" }
  },
  "observations": [
    { "phase": "string", "priority": 1, "observation": "1-2 sentences", "suggestion": "1-2 sentences", "frameIndex": 0, "frameLabel": "down the line" }
  ],
  "positives": "1-2 sentences",
  "nextSession": "1 sentence"
}

Max 2-3 observations. Direct, specific, encouraging. Plain language.`;

  const images = frames.map(f => ({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: f.base64 } }));
  const text = {
    type: 'text',
    text: `${frames.length} golf swing frames${hasMulti ? ' from two angles' : ''}. In order: ${frames.map((f, i) => `Frame ${i} ‚Äî ${f.label}, ${f.phase}`).join('; ')}. Analyse and return JSON.`
  };

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-opus-4-6',
      max_tokens: 1500,
      system,
      messages: [{ role: 'user', content: [...images, text] }]
    })
  });

  if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `API error ${res.status}`); }
  const data = await res.json();
  const match = data.content[0].text.match(/\{[\s\S]*\}/);
  if (!match) throw new Error('Could not parse AI response');
  return JSON.parse(match[0]);
}

// RENDER
function renderResults(analysis, frames) {
  const container = document.getElementById('results-content');
  const tp = analysis.topPriority;

  function getFrame(frameIndex, frameLabel) {
    const labelFrames = frames.filter(f => f.label === frameLabel);
    return labelFrames[frameIndex] || frames[frameIndex] || frames[0] || null;
  }

  function frameBlock(frameIndex, frameLabel) {
    const f = getFrame(frameIndex, frameLabel);
    if (!f) return '';
    return `
      <div>
        <div class="rl">Frame Reference ¬∑ ${f.phase} ¬∑ ${f.label}</div>
        <img class="frame-img" src="data:image/jpeg;base64,${f.base64}" alt="${f.phase}">
        <div class="frame-cap">‚Üë This is the frame the AI is referring to</div>
      </div>`;
  }

  let html = `
  <div class="top-banner">
    <span class="banner-icon">üéØ</span>
    <div>
      <div class="banner-label">Fix This First</div>
      <div class="banner-text"><strong style="color:var(--text)">${tp.phase}:</strong> ${tp.issue}</div>
    </div>
  </div>

  <div class="result-card">
    <div class="result-card-header">
      <div class="result-phase">${tp.phase}</div>
      <span class="priority-badge p1">üî¥ Top Priority</span>
    </div>
    <div class="result-card-body">
      ${frameBlock(tp.frameIndex, tp.frameLabel)}
      <div><div class="rl">Why This Matters</div><div class="rt">${tp.why}</div></div>
      <div><div class="rl">What To Do</div><div class="rt">${tp.fix}</div></div>
      <div class="drill-box">
        <div class="drill-title">‚õ≥ ${tp.drill.name}</div>
        <div class="drill-text">${tp.drill.instructions}</div>
      </div>
    </div>
  </div>`;

  if (analysis.observations?.length) {
    html += `<div><div class="rl" style="padding:0 4px;">Other Observations</div></div>`;
    analysis.observations.forEach(obs => {
      const pc = obs.priority === 1 ? 'p1' : obs.priority === 2 ? 'p2' : 'p3';
      const pl = obs.priority === 1 ? 'üî¥ High' : obs.priority === 2 ? 'üü° Medium' : 'üü¢ Minor';
      html += `
      <div class="result-card">
        <div class="result-card-header">
          <div class="result-phase">${obs.phase}</div>
          <span class="priority-badge ${pc}">${pl}</span>
        </div>
        <div class="result-card-body">
          ${frameBlock(obs.frameIndex, obs.frameLabel)}
          <div><div class="rl">What I See</div><div class="rt">${obs.observation}</div></div>
          <div><div class="rl">Suggestion</div><div class="rt-dim">${obs.suggestion}</div></div>
        </div>
      </div>`;
    });
  }

  if (analysis.positives) {
    html += `
    <div class="result-card">
      <div class="result-card-body">
        <div class="rl">What You're Doing Well</div>
        <div class="rt">‚úÖ ${analysis.positives}</div>
      </div>
    </div>`;
  }

  if (analysis.nextSession) {
    html += `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;">
      <div class="rl" style="margin-bottom:6px;">After You've Fixed This ‚Üí</div>
      <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">${analysis.nextSession}</div>
    </div>`;
  }

  // All frames strip
  if (frames.length) {
    html += `
    <div>
      <div class="rl" style="padding:0 4px;margin-bottom:10px;">All Extracted Frames</div>
      <div class="frame-strip">
        ${frames.map(f => `
          <div class="frame-thumb-wrap">
            <img class="frame-thumb" src="data:image/jpeg;base64,${f.base64}" alt="${f.phase}">
            <div class="frame-thumb-cap">${f.phase}</div>
          </div>`).join('')}
      </div>
    </div>`;
  }

  container.innerHTML = html;
  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-results').classList.remove('hidden');
  document.getElementById('screen-analysis').scrollTo(0, 0);
}

// HISTORY
function renderHistory() {
  const list = document.getElementById('history-list');
  if (!state.history.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div>No sessions yet.<br>Record your first swing to get started.</div>`;
    return;
  }
  list.innerHTML = state.history.map(item => `
    <div class="history-item" onclick="viewHistory(${item.id})">
      <div class="hi-top">
        <span class="hi-date">${item.date}</span>
        <span class="hi-focus">${item.focusLabel}</span>
      </div>
      <div class="hi-summary"><strong>${item.analysis?.topPriority?.phase || ''}:</strong> ${item.analysis?.topPriority?.issue || 'Tap to view'}</div>
    </div>`).join('');
}

function viewHistory(id) {
  const item = state.history.find(h => h.id === id); if (!item) return;
  document.getElementById('analysis-focus-text').textContent = item.focusLabel;
  showScreen('analysis');
  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-results').classList.remove('hidden');
  renderResults(item.analysis, item.frames || []);
}

// UTILS
function toast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.classList.remove('show'), 3500);
}
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
